<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>重置密码 - 22306订票系统</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        .reset-container {
            max-width: 450px;
            margin: 100px auto;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-container">
            <a href="/" class="navbar-logo">22306</a>
            <ul class="navbar-menu">
                <li><a href="/">首页</a></li>
            </ul>
        </div>
    </nav>

    <div class="reset-container">
        <div class="card">
            <div class="card-header text-center">重置密码</div>
            
            <!-- 步骤1: 输入用户名 -->
            <div id="step1">
                <div class="form-group">
                    <label>用户名</label>
                    <input type="text" class="form-control" id="username" required>
                </div>
                <button class="btn btn-primary btn-block" onclick="getSecurityQuestion()">下一步</button>
            </div>

            <!-- 步骤2: 回答安全问题 -->
            <div id="step2" style="display:none;">
                <div class="form-group">
                    <label>安全问题</label>
                    <input type="text" class="form-control" id="security_question" disabled>
                </div>
                <div class="form-group">
                    <label>答案</label>
                    <input type="text" class="form-control" id="security_answer" required>
                </div>
                <div class="form-group">
                    <label>新密码</label>
                    <input type="password" class="form-control" id="new_password" required>
                </div>
                <div class="form-group">
                    <label>确认新密码</label>
                    <input type="password" class="form-control" id="confirm_password" required>
                </div>
                <button class="btn btn-primary btn-block" onclick="resetPassword()">重置密码</button>
                <button class="btn btn-secondary btn-block" onclick="backToStep1()">返回</button>
            </div>

            <div class="mt-2 text-center">
                <a href="/login">返回登录</a>
            </div>
        </div>
    </div>

    <script src="/static/js/common.js"></script>
    <script>
        async function getSecurityQuestion() {
            const username = document.getElementById('username').value;
            if (!username) {
                showMessage('请输入用户名', 'warning');
                return;
            }

            const result = await apiRequest(
                `${API_BASE}/auth/get_security_question?username=${encodeURIComponent(username)}`
            );

            if (result.success) {
                document.getElementById('security_question').value = result.security_question;
                document.getElementById('step1').style.display = 'none';
                document.getElementById('step2').style.display = 'block';
            } else {
                showMessage(result.message || '用户不存在', 'danger');
            }
        }

        async function resetPassword() {
            const username = document.getElementById('username').value;
            const securityAnswer = document.getElementById('security_answer').value;
            const newPassword = document.getElementById('new_password').value;
            const confirmPassword = document.getElementById('confirm_password').value;

            if (!securityAnswer || !newPassword || !confirmPassword) {
                showMessage('请填写所有字段', 'warning');
                return;
            }

            if (newPassword !== confirmPassword) {
                showMessage('两次密码输入不一致', 'warning');
                return;
            }

            if (newPassword.length < 6) {
                showMessage('密码长度至少6位', 'warning');
                return;
            }

            const result = await apiRequest(`${API_BASE}/auth/reset_password`, 'POST', {
                username,
                security_answer: securityAnswer,
                new_password: newPassword
            });

            if (result.success) {
                showMessage('密码重置成功！', 'success');
                setTimeout(() => {
                    window.location.href = '/login';
                }, 1500);
            } else {
                showMessage(result.message || '重置失败', 'danger');
            }
        }

        function backToStep1() {
            document.getElementById('step1').style.display = 'block';
            document.getElementById('step2').style.display = 'none';
            document.getElementById('security_answer').value = '';
            document.getElementById('new_password').value = '';
            document.getElementById('confirm_password').value = '';
        }
    </script>
</body>
</html>

