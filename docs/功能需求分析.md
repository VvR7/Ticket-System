# 22306订票系统 - 功能需求分析

## 一、系统概述

22306订票系统是一个面向长途汽车与火车的车站售票管理系统，提供便捷、快速的售票服务，支持用户查询、预订、退票等功能，同时为管理员提供完善的管理和报表功能。

## 二、用户角色

### 2.1 普通用户
- 注册和登录系统
- 查询车次信息
- 预订车票（个人/团体）
- 查看我的订单
- 退票操作

### 2.2 管理员
- 拥有普通用户的所有权限
- 管理车站、线路、车次
- 调整票价、班次状态
- 查看和导出报表
- 查看操作日志

## 三、功能模块

### 3.1 用户认证模块

#### 3.1.1 用户注册
**功能描述**：新用户注册账号

**输入**：
- 用户名（唯一）
- 密码（至少6位）
- 真实姓名
- 安全问题及答案

**输出**：
- 注册成功/失败消息
- 自动创建用户记录

**业务规则**：
- 用户名不能重复
- 密码需要加密存储
- 安全问题用于找回密码

#### 3.1.2 用户登录
**功能描述**：用户登录系统

**输入**：
- 用户名
- 密码

**输出**：
- 登录成功/失败
- 创建会话
- 返回用户信息

**业务规则**：
- 验证用户名密码
- 创建session记录
- 管理员登录后跳转到管理后台

#### 3.1.3 密码重置
**功能描述**：通过安全问题重置密码

**输入**：
- 用户名
- 安全问题答案
- 新密码

**输出**：
- 重置成功/失败消息

**业务规则**：
- 验证安全问题答案
- 新密码加密后更新

### 3.2 车票查询模块

#### 3.2.1 多条件查询
**功能描述**：根据多种条件查询班次

**查询条件**：
- 出发城市
- 到达城市
- 出发日期
- 班次号

**输出信息**：
- 班次号
- 线路名称
- 出发站/到达站
- 发车时间/到达时间
- 票价
- 余票数量
- 班次状态（正常/延误/取消）

**业务规则**：
- 支持单条件或多条件组合查询
- 显示实时余票信息
- 延误班次显示延误时长

#### 3.2.2 车站列表查询
**功能描述**：获取所有车站信息

**输出**：
- 车站列表（按省份、城市分组）

### 3.3 订票模块

#### 3.3.1 个人订票
**功能描述**：个人用户订购单张车票

**输入**：
- 班次ID
- 座位ID
- 乘客姓名
- 身份证号

**输出**：
- 订单信息
- 车票信息

**业务规则**：
- 必须登录
- 座位不能重复预订
- 使用事务确保数据一致性
- 使用悲观锁防止超卖

#### 3.3.2 团体订票
**功能描述**：一次性为多人订票

**输入**：
- 班次ID
- 多个乘客信息（姓名、身份证号、座位）

**输出**：
- 订单信息（标记为团体订单）
- 多张车票信息

**业务规则**：
- 所有座位必须可用
- 全部成功或全部失败（事务）
- 订单类型标记为"团体"

#### 3.3.3 座位选择
**功能描述**：可视化选择座位

**显示**：
- 座位布局图
- 座位状态（可选/已售）
- 座位类型

**交互**：
- 点击选择/取消座位
- 支持多选（团体）

### 3.4 订单管理模块

#### 3.4.1 我的订单
**功能描述**：查看用户的所有订单

**显示信息**：
- 订单基本信息
- 车次信息
- 车票详情列表
- 订单状态

**操作**：
- 查看详情
- 退票

#### 3.4.2 退票
**功能描述**：退订已购车票

**输入**：
- 车票ID列表
- 退票原因（可选）

**输出**：
- 退票成功/失败
- 退款金额

**业务规则**：
- 只能退有效车票
- 更新车票状态为"已退票"
- 创建退票记录
- 释放座位
- 如订单所有票都退，订单状态改为"已退款"

### 3.5 管理员模块

#### 3.5.1 车站管理
**功能**：
- 添加车站
- 删除车站（需检查是否被使用）
- 查看车站列表

#### 3.5.2 线路管理
**功能**：
- 添加线路（起始站、终点站）
- 删除线路（需检查是否有班次）
- 查看线路列表

#### 3.5.3 班次管理
**功能**：
- 添加班次
- 删除班次（需检查是否有订单）
- 更新班次信息（时间、票价、状态、延误）
- 批量更新票价（按线路）

#### 3.5.4 报表系统
**销售报表**：
- 按日期统计销售额
- 订单数、票数统计
- 团体订单统计

**班次统计报表**：
- 各班次运营情况
- 正常/延误/取消统计
- 收入统计

**退票统计报表**：
- 按日期统计退票情况
- 退票金额统计

**报表导出**：
- 导出综合报表为CSV格式

#### 3.5.5 操作日志
**功能**：记录和查看管理员的所有操作

**记录内容**：
- 操作时间
- 操作员
- 操作类型
- 操作描述
- IP地址

## 四、非功能需求

### 4.1 性能需求
- 页面响应时间 < 2秒
- 支持并发订票
- 数据库查询优化

### 4.2 安全需求
- 密码加密存储（bcrypt）
- SQL注入防护
- 会话管理
- 权限验证

### 4.3 可用性需求
- 界面简洁直观
- 操作流程简单
- 错误提示清晰

### 4.4 可靠性需求
- 事务保证数据一致性
- 防止超卖
- 数据完整性约束

## 五、用例图

```
用户
├── 注册
├── 登录
├── 查询车次
├── 订票（个人/团体）
├── 查看订单
└── 退票

管理员（继承用户）
├── 管理车站
├── 管理线路
├── 管理班次
├── 更新票价
├── 查看报表
├── 导出报表
└── 查看日志
```

## 六、业务流程

### 6.1 订票流程
```
1. 用户登录
2. 查询车次
3. 选择班次
4. 选择座位
5. 填写乘客信息
6. 确认订单
7. 系统检查座位可用性
8. 锁定座位
9. 创建订单和车票
10. 提交事务
11. 返回订单信息
```

### 6.2 退票流程
```
1. 用户进入"我的订单"
2. 选择要退的车票
3. 填写退票原因（可选）
4. 确认退票
5. 系统验证车票状态
6. 锁定车票记录
7. 更新车票状态
8. 创建退票记录
9. 更新订单状态
10. 提交事务
11. 返回退款信息
```

## 七、数据流图

### 7.1 订票数据流
```
用户 → [查询请求] → 系统 → [查询SQL] → 数据库
数据库 → [班次数据] → 系统 → [班次列表] → 用户
用户 → [订票请求] → 系统 → [验证+事务] → 数据库
数据库 → [订单数据] → 系统 → [订单确认] → 用户
```

### 7.2 管理员操作数据流
```
管理员 → [管理请求] → 系统 → [权限验证] → 
[操作数据库] → [记录日志] → [返回结果] → 管理员
```

## 八、接口需求

### 8.1 前端接口
- RESTful API
- JSON数据格式
- HTTP状态码标准化

### 8.2 数据库接口
- MySQL数据库
- 参数化查询
- 事务支持

## 九、测试需求

### 9.1 功能测试
- 注册登录功能
- 查询功能
- 订票功能
- 退票功能
- 管理功能

### 9.2 性能测试
- 并发订票测试
- 压力测试

### 9.3 安全测试
- SQL注入测试
- 权限验证测试

