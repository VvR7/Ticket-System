# 22306订票系统 - 系统数据字典

## 一、数据项说明

### 1.1 用户相关

| 数据项 | 中文名称 | 类型 | 长度 | 约束 | 说明 |
|--------|----------|------|------|------|------|
| user_id | 用户ID | INT | - | PK, AI | 主键，自增 |
| username | 用户名 | VARCHAR | 50 | UK, NN | 唯一，不为空 |
| password | 密码 | VARCHAR | 255 | NN | bcrypt加密 |
| real_name | 真实姓名 | VARCHAR | 50 | NN | - |
| security_question | 安全问题 | VARCHAR | 200 | NN | 用于找回密码 |
| security_answer | 安全问题答案 | VARCHAR | 100 | NN | - |
| created_at | 注册时间 | DATETIME | - | DEFAULT NOW | - |
| is_admin | 是否管理员 | BOOLEAN | - | DEFAULT FALSE | - |

### 1.2 会话相关

| 数据项 | 中文名称 | 类型 | 长度 | 约束 | 说明 |
|--------|----------|------|------|------|------|
| session_id | 会话ID | VARCHAR | 64 | PK | 主键 |
| user_id | 用户ID | INT | - | FK, NN | 外键关联User |
| login_time | 登录时间 | DATETIME | - | DEFAULT NOW | - |
| expire_time | 过期时间 | DATETIME | - | NN | - |
| token | 会话令牌 | VARCHAR | 128 | UK, NN | 唯一 |
| device_info | 设备信息 | VARCHAR | 200 | - | User-Agent |

### 1.3 车站相关

| 数据项 | 中文名称 | 类型 | 长度 | 约束 | 说明 |
|--------|----------|------|------|------|------|
| station_id | 车站ID | INT | - | PK, AI | 主键 |
| station_name | 车站名称 | VARCHAR | 100 | NN | - |
| city | 所在城市 | VARCHAR | 50 | NN | - |
| province | 所在省份 | VARCHAR | 50 | NN | - |
| station_type | 车站类型 | ENUM | - | NN | train/bus/both |
| address | 详细地址 | VARCHAR | 200 | - | - |
| created_at | 创建时间 | DATETIME | - | DEFAULT NOW | - |

### 1.4 线路相关

| 数据项 | 中文名称 | 类型 | 长度 | 约束 | 说明 |
|--------|----------|------|------|------|------|
| route_id | 线路ID | INT | - | PK, AI | 主键 |
| route_name | 线路名称 | VARCHAR | 100 | NN | - |
| start_station_id | 起始站ID | INT | - | FK, NN | 外键 |
| end_station_id | 终点站ID | INT | - | FK, NN | 外键 |
| route_type | 线路类型 | ENUM | - | NN | train/bus |
| total_distance | 总里程 | DECIMAL | 10,2 | - | 单位：公里 |
| created_at | 创建时间 | DATETIME | - | DEFAULT NOW | - |

### 1.5 车辆相关

| 数据项 | 中文名称 | 类型 | 长度 | 约束 | 说明 |
|--------|----------|------|------|------|------|
| vehicle_id | 车辆ID | INT | - | PK, AI | 主键 |
| vehicle_no | 车辆编号 | VARCHAR | 50 | UK, NN | 唯一 |
| vehicle_type | 车辆类型 | ENUM | - | NN | train/bus |
| seat_count | 座位总数 | INT | - | NN, CHECK>0 | 必须大于0 |
| seat_layout | 座位布局 | VARCHAR | 50 | - | 如"3+2" |
| manufacturer | 制造商 | VARCHAR | 100 | - | - |
| created_at | 创建时间 | DATETIME | - | DEFAULT NOW | - |

### 1.6 座位相关

| 数据项 | 中文名称 | 类型 | 长度 | 约束 | 说明 |
|--------|----------|------|------|------|------|
| seat_id | 座位ID | INT | - | PK, AI | 主键 |
| vehicle_id | 车辆ID | INT | - | FK, NN | 外键 |
| seat_no | 座位编号 | VARCHAR | 20 | NN | - |
| seat_type | 座位类型 | ENUM | - | NN | 见座位类型说明 |
| carriage_no | 车厢号 | VARCHAR | 10 | - | 仅火车 |

### 1.7 班次相关

| 数据项 | 中文名称 | 类型 | 长度 | 约束 | 说明 |
|--------|----------|------|------|------|------|
| schedule_id | 班次ID | INT | - | PK, AI | 主键 |
| schedule_no | 班次号 | VARCHAR | 50 | NN | 如"G1" |
| route_id | 线路ID | INT | - | FK, NN | 外键 |
| vehicle_id | 车辆ID | INT | - | FK, NN | 外键 |
| departure_date | 发车日期 | DATE | - | NN | - |
| departure_time | 发车时间 | TIME | - | NN | - |
| arrival_time | 到达时间 | TIME | - | NN | - |
| base_price | 基础票价 | DECIMAL | 10,2 | NN, CHECK>=0 | - |
| status | 班次状态 | ENUM | - | DEFAULT normal | normal/delayed/cancelled |
| delay_minutes | 延误分钟数 | INT | - | DEFAULT 0 | - |
| created_at | 创建时间 | DATETIME | - | DEFAULT NOW | - |

### 1.8 订单相关

| 数据项 | 中文名称 | 类型 | 长度 | 约束 | 说明 |
|--------|----------|------|------|------|------|
| order_id | 订单ID | INT | - | PK, AI | 主键 |
| user_id | 用户ID | INT | - | FK, NN | 外键 |
| schedule_id | 班次ID | INT | - | FK, NN | 外键 |
| order_time | 下单时间 | DATETIME | - | DEFAULT NOW | - |
| total_amount | 订单总金额 | DECIMAL | 10,2 | NN, CHECK>=0 | - |
| ticket_count | 票数 | INT | - | NN, CHECK>0 | - |
| order_type | 订单类型 | ENUM | - | DEFAULT individual | individual/group |
| status | 订单状态 | ENUM | - | DEFAULT confirmed | pending/confirmed/cancelled/refunded |

### 1.9 车票相关

| 数据项 | 中文名称 | 类型 | 长度 | 约束 | 说明 |
|--------|----------|------|------|------|------|
| ticket_id | 车票ID | INT | - | PK, AI | 主键 |
| order_id | 订单ID | INT | - | FK, NN | 外键 |
| schedule_id | 班次ID | INT | - | FK, NN | 外键 |
| seat_id | 座位ID | INT | - | FK, NN | 外键 |
| passenger_name | 乘客姓名 | VARCHAR | 50 | NN | - |
| card_id | 身份证号 | VARCHAR | 18 | NN | - |
| price | 票价 | DECIMAL | 10,2 | NN, CHECK>=0 | - |
| status | 车票状态 | ENUM | - | DEFAULT valid | valid/refunded |
| created_at | 创建时间 | DATETIME | - | DEFAULT NOW | - |

### 1.10 退票相关

| 数据项 | 中文名称 | 类型 | 长度 | 约束 | 说明 |
|--------|----------|------|------|------|------|
| refund_id | 退票ID | INT | - | PK, AI | 主键 |
| ticket_id | 车票ID | INT | - | FK, UK, NN | 外键，唯一 |
| refund_time | 退票时间 | DATETIME | - | DEFAULT NOW | - |
| refund_amount | 退款金额 | DECIMAL | 10,2 | NN, CHECK>=0 | - |
| refund_reason | 退票原因 | TEXT | - | - | - |
| handled_by | 处理人ID | INT | - | FK | 外键 |

### 1.11 日志相关

| 数据项 | 中文名称 | 类型 | 长度 | 约束 | 说明 |
|--------|----------|------|------|------|------|
| log_id | 日志ID | INT | - | PK, AI | 主键 |
| user_id | 操作员ID | INT | - | FK | 外键 |
| operation_type | 操作类型 | VARCHAR | 50 | NN | - |
| operation_desc | 操作描述 | TEXT | - | - | - |
| target_table | 目标表 | VARCHAR | 50 | - | - |
| target_id | 目标记录ID | INT | - | - | - |
| operation_time | 操作时间 | DATETIME | - | DEFAULT NOW | - |
| ip_address | IP地址 | VARCHAR | 50 | - | - |

## 二、枚举类型说明

### 2.1 station_type (车站类型)
| 值 | 说明 |
|----|------|
| train | 火车站 |
| bus | 汽车站 |
| both | 火车站+汽车站 |

### 2.2 route_type / vehicle_type (线路类型/车辆类型)
| 值 | 说明 |
|----|------|
| train | 火车 |
| bus | 长途客车 |

### 2.3 seat_type (座位类型)
| 值 | 说明 | 适用 |
|----|------|------|
| hard_seat | 硬座 | 火车 |
| soft_seat | 软座 | 火车/客车 |
| hard_sleeper | 硬卧 | 火车 |
| soft_sleeper | 软卧 | 火车 |
| business | 商务座 | 高铁 |
| first_class | 一等座 | 高铁 |
| second_class | 二等座 | 高铁 |

### 2.4 schedule_status (班次状态)
| 值 | 说明 |
|----|------|
| normal | 正常 |
| delayed | 延误 |
| cancelled | 取消 |

### 2.5 order_status (订单状态)
| 值 | 说明 |
|----|------|
| pending | 待确认 |
| confirmed | 已确认 |
| cancelled | 已取消 |
| refunded | 已退款 |

### 2.6 ticket_status (车票状态)
| 值 | 说明 |
|----|------|
| valid | 有效 |
| refunded | 已退票 |

### 2.7 order_type (订单类型)
| 值 | 说明 |
|----|------|
| individual | 个人订单 |
| group | 团体订单 |

## 三、数据关系说明

### 3.1 一对多关系

| 主表 | 从表 | 说明 |
|------|------|------|
| User | Order | 一个用户可以有多个订单 |
| User | Session | 一个用户可以有多个会话 |
| Station | Route (start) | 一个车站可以是多条线路的起点 |
| Station | Route (end) | 一个车站可以是多条线路的终点 |
| Route | Schedule | 一条线路可以有多个班次 |
| Vehicle | Seat | 一个车辆有多个座位 |
| Vehicle | Schedule | 一个车辆可以有多个班次 |
| Schedule | Order | 一个班次可以有多个订单 |
| Schedule | Ticket | 一个班次可以有多张车票 |
| Order | Ticket | 一个订单可以有多张车票 |
| Seat | Ticket | 一个座位可以有多张票（不同班次） |

### 3.2 一对一关系

| 主表 | 从表 | 说明 |
|------|------|------|
| Ticket | Refund | 一张票最多一条退票记录 |

### 3.3 多对多关系

| 表1 | 表2 | 中间表 | 说明 |
|-----|-----|--------|------|
| Route | Station | Route_Station | 线路经过多个站点 |

## 四、索引说明

### 4.1 主键索引
所有表的主键字段自动创建聚集索引。

### 4.2 唯一索引
| 表 | 字段 | 说明 |
|----|------|------|
| User | username | 用户名唯一 |
| Session | token | 令牌唯一 |
| Vehicle | vehicle_no | 车辆编号唯一 |
| Seat | (vehicle_id, seat_no) | 车辆内座位号唯一 |
| Schedule | (schedule_no, departure_date) | 同一班次号同一天唯一 |
| Route_Station | (route_id, order_no) | 线路内站点顺序唯一 |
| Refund | ticket_id | 一票一退 |

### 4.3 普通索引
| 表 | 字段 | 用途 |
|----|------|------|
| User | real_name | 按姓名查询 |
| Station | city | 按城市查询 |
| Station | station_type | 按类型查询 |
| Schedule | departure_date | 按日期查询 |
| Schedule | status | 按状态查询 |
| Order | user_id | 查询用户订单 |
| Order | order_time | 按时间排序 |
| Ticket | passenger_name | 按乘客查询 |
| Admin_Log | operation_time | 按时间查询日志 |

## 五、约束说明

### 5.1 非空约束 (NOT NULL)
所有标记为NN的字段不能为空。

### 5.2 检查约束 (CHECK)
- 票价、金额 >= 0
- 座位数 > 0
- 延误分钟数 >= 0
- 票数 > 0

### 5.3 外键约束
所有FK字段都有外键约束，删除策略：
- CASCADE: 级联删除（Session, Ticket等）
- SET NULL: 设置为NULL（Admin_Log）
- RESTRICT: 禁止删除（默认）

### 5.4 默认值约束
- 时间字段默认当前时间
- 状态字段默认初始状态
- 布尔字段默认FALSE

## 六、数据完整性

### 6.1 实体完整性
- 所有表都有主键
- 主键值唯一且非空

### 6.2 参照完整性
- 外键约束确保引用的一致性
- 删除时检查依赖关系

### 6.3 用户定义完整性
- 枚举类型限制值范围
- CHECK约束限制数值范围
- 唯一约束防止重复

## 七、数据安全

### 7.1 敏感数据
| 字段 | 安全措施 |
|------|----------|
| password | bcrypt加密 |
| security_answer | 明文存储（可考虑加密） |
| card_id | 建议加密存储 |

### 7.2 审计跟踪
- Admin_Log表记录所有管理操作
- 包含操作时间、操作员、IP等信息

