# 22306订票系统 - 数据库关系模式设计

## 一、ER图

```
┌─────────┐
│  User   │──────1:N──────┐
└─────────┘               │
                          ▼
┌─────────┐          ┌─────────┐
│ Session │──N:1────▶│  Order  │──────1:N──────┐
└─────────┘          └─────────┘               │
                          │                    ▼
                          │               ┌─────────┐
                      1:N │          ┌───▶│ Ticket  │───1:0..1───┐
                          │          │    └─────────┘            │
                          ▼          │         │                 ▼
┌─────────┐          ┌──────────┐   │         │            ┌─────────┐
│ Vehicle │──1:N────▶│ Schedule │───┘      1:N│            │ Refund  │
└─────────┘          └──────────┘              │            └─────────┘
     │                    │                    │
  1:N│                 1:N│                    │
     │                    ▼                    ▼
     │         ┌──────────────────┐       ┌─────────┐
     │         │ Route_Station    │──N:1─▶│  Seat   │
     │         └──────────────────┘       └─────────┘
     │                    │
     ▼                    │
┌─────────┐            N:1│
│  Seat   │               │
└─────────┘               ▼
                     ┌─────────┐
                     │ Station │
                     └─────────┘
                          │
                       N:1│
                          ▼
                     ┌─────────┐
                     │  Route  │
                     └─────────┘

┌──────────┐
│Admin_Log │ (独立表，记录管理员操作)
└──────────┘
```

### 简化ER关系图

```
User 1—N Order
User 1—N Session
Order 1—N Ticket
Station 1—N Route_Station
Route 1—N Route_Station
Route 1—N Schedule
Vehicle 1—N Seat
Vehicle 1—N Schedule
Schedule 1—N Order
Schedule 1—N Ticket
Seat 1—0..N Ticket
Ticket 1—0..1 Refund
```

## 二、详细关系模式

### 2.1 用户与权限相关

#### User (用户表)
记录注册用户的基本信息和认证信息

| 字段名 | 类型 | 约束 | 说明 |
|-------|------|------|------|
| user_id | INT | PRIMARY KEY, AUTO_INCREMENT | 用户ID |
| username | VARCHAR(50) | UNIQUE, NOT NULL | 用户名 |
| password | VARCHAR(255) | NOT NULL | 密码（加密存储） |
| real_name | VARCHAR(50) | NOT NULL | 真实姓名 |
| security_question | VARCHAR(200) | NOT NULL | 安全问题 |
| security_answer | VARCHAR(100) | NOT NULL | 安全问题答案 |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 注册时间 |
| is_admin | BOOLEAN | DEFAULT FALSE | 是否为管理员 |

**索引**:
- PRIMARY KEY: user_id
- UNIQUE INDEX: username
- INDEX: real_name (支持按姓名查询订单)

---

#### Session (会话表)
记录用户登录会话信息

| 字段名 | 类型 | 约束 | 说明 |
|-------|------|------|------|
| session_id | VARCHAR(64) | PRIMARY KEY | 会话ID |
| user_id | INT | FOREIGN KEY | 用户ID |
| login_time | DATETIME | DEFAULT CURRENT_TIMESTAMP | 登录时间 |
| expire_time | DATETIME | NOT NULL | 过期时间 |
| token | VARCHAR(128) | UNIQUE, NOT NULL | 会话令牌 |
| device_info | VARCHAR(200) | | 设备信息 |

**索引**:
- PRIMARY KEY: session_id
- INDEX: user_id
- INDEX: token
- INDEX: expire_time (用于清理过期会话)

**外键**:
- user_id REFERENCES User(user_id) ON DELETE CASCADE

---

#### Admin_Log (管理员操作日志表)
记录管理员的所有操作

| 字段名 | 类型 | 约束 | 说明 |
|-------|------|------|------|
| log_id | INT | PRIMARY KEY, AUTO_INCREMENT | 日志ID |
| user_id | INT | FOREIGN KEY | 操作管理员ID |
| operation_type | VARCHAR(50) | NOT NULL | 操作类型 |
| operation_desc | TEXT | | 操作描述 |
| target_table | VARCHAR(50) | | 操作的目标表 |
| target_id | INT | | 操作的目标记录ID |
| operation_time | DATETIME | DEFAULT CURRENT_TIMESTAMP | 操作时间 |
| ip_address | VARCHAR(50) | | IP地址 |

**索引**:
- PRIMARY KEY: log_id
- INDEX: user_id
- INDEX: operation_time
- INDEX: operation_type

**外键**:
- user_id REFERENCES User(user_id) ON DELETE SET NULL

---

### 2.2 线路与车站相关

#### Station (车站信息表)
记录所有车站的基本信息

| 字段名 | 类型 | 约束 | 说明 |
|-------|------|------|------|
| station_id | INT | PRIMARY KEY, AUTO_INCREMENT | 车站ID |
| station_name | VARCHAR(100) | NOT NULL | 车站名称 |
| city | VARCHAR(50) | NOT NULL | 所在城市 |
| province | VARCHAR(50) | NOT NULL | 所在省份 |
| station_type | ENUM('train', 'bus', 'both') | NOT NULL | 车站类型 |
| address | VARCHAR(200) | | 详细地址 |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |

**索引**:
- PRIMARY KEY: station_id
- INDEX: city
- INDEX: station_type
- INDEX: station_name

---

#### Route (线路信息表)
记录固定的线路（起点→终点）

| 字段名 | 类型 | 约束 | 说明 |
|-------|------|------|------|
| route_id | INT | PRIMARY KEY, AUTO_INCREMENT | 线路ID |
| route_name | VARCHAR(100) | NOT NULL | 线路名称 |
| start_station_id | INT | FOREIGN KEY, NOT NULL | 起始站ID |
| end_station_id | INT | FOREIGN KEY, NOT NULL | 终点站ID |
| route_type | ENUM('train', 'bus') | NOT NULL | 线路类型 |
| total_distance | DECIMAL(10,2) | | 总里程(km) |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |

**索引**:
- PRIMARY KEY: route_id
- INDEX: start_station_id
- INDEX: end_station_id
- INDEX: route_type

**外键**:
- start_station_id REFERENCES Station(station_id)
- end_station_id REFERENCES Station(station_id)

---

#### Route_Station (线路站点表)
描述线路由哪些站点组成及顺序

| 字段名 | 类型 | 约束 | 说明 |
|-------|------|------|------|
| id | INT | PRIMARY KEY, AUTO_INCREMENT | 记录ID |
| route_id | INT | FOREIGN KEY, NOT NULL | 线路ID |
| station_id | INT | FOREIGN KEY, NOT NULL | 车站ID |
| order_no | INT | NOT NULL | 站点顺序(1,2,3...) |
| distance_from_start | DECIMAL(10,2) | | 距离起点距离(km) |
| estimated_minutes | INT | | 预计到达分钟数 |

**索引**:
- PRIMARY KEY: id
- UNIQUE INDEX: (route_id, order_no)
- INDEX: route_id
- INDEX: station_id

**外键**:
- route_id REFERENCES Route(route_id) ON DELETE CASCADE
- station_id REFERENCES Station(station_id)

---

### 2.3 车辆与座位相关

#### Vehicle (车辆表)
记录车辆信息

| 字段名 | 类型 | 约束 | 说明 |
|-------|------|------|------|
| vehicle_id | INT | PRIMARY KEY, AUTO_INCREMENT | 车辆ID |
| vehicle_no | VARCHAR(50) | UNIQUE, NOT NULL | 车辆编号 |
| vehicle_type | ENUM('train', 'bus') | NOT NULL | 车辆类型 |
| seat_count | INT | NOT NULL | 座位总数 |
| seat_layout | VARCHAR(50) | | 座位布局(如3+2) |
| manufacturer | VARCHAR(100) | | 制造商 |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |

**索引**:
- PRIMARY KEY: vehicle_id
- UNIQUE INDEX: vehicle_no
- INDEX: vehicle_type

---

#### Seat (座位表)
记录车辆的座位信息

| 字段名 | 类型 | 约束 | 说明 |
|-------|------|------|------|
| seat_id | INT | PRIMARY KEY, AUTO_INCREMENT | 座位ID |
| vehicle_id | INT | FOREIGN KEY, NOT NULL | 车辆ID |
| seat_no | VARCHAR(20) | NOT NULL | 座位编号 |
| seat_type | ENUM('hard_seat', 'soft_seat', 'hard_sleeper', 'soft_sleeper', 'business', 'first_class', 'second_class') | NOT NULL | 座位类型 |
| carriage_no | VARCHAR(10) | | 车厢号 |

**索引**:
- PRIMARY KEY: seat_id
- UNIQUE INDEX: (vehicle_id, seat_no)
- INDEX: vehicle_id
- INDEX: seat_type

**外键**:
- vehicle_id REFERENCES Vehicle(vehicle_id) ON DELETE CASCADE

---

### 2.4 班次调度相关

#### Schedule (班次表)
记录每日具体班次信息

| 字段名 | 类型 | 约束 | 说明 |
|-------|------|------|------|
| schedule_id | INT | PRIMARY KEY, AUTO_INCREMENT | 班次ID |
| schedule_no | VARCHAR(50) | NOT NULL | 班次号(如K120) |
| route_id | INT | FOREIGN KEY, NOT NULL | 线路ID |
| vehicle_id | INT | FOREIGN KEY, NOT NULL | 车辆ID |
| departure_date | DATE | NOT NULL | 发车日期 |
| departure_time | TIME | NOT NULL | 发车时间 |
| arrival_time | TIME | NOT NULL | 到达时间 |
| base_price | DECIMAL(10,2) | NOT NULL | 基础票价 |
| status | ENUM('normal', 'delayed', 'cancelled') | DEFAULT 'normal' | 班次状态 |
| delay_minutes | INT | DEFAULT 0 | 延误分钟数 |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |

**索引**:
- PRIMARY KEY: schedule_id
- UNIQUE INDEX: (schedule_no, departure_date)
- INDEX: route_id
- INDEX: vehicle_id
- INDEX: departure_date
- INDEX: status

**外键**:
- route_id REFERENCES Route(route_id)
- vehicle_id REFERENCES Vehicle(vehicle_id)

---

### 2.5 售票业务相关

#### Order (订单表)
记录一次购票行为（个人或团体）

| 字段名 | 类型 | 约束 | 说明 |
|-------|------|------|------|
| order_id | INT | PRIMARY KEY, AUTO_INCREMENT | 订单ID |
| user_id | INT | FOREIGN KEY, NOT NULL | 用户ID |
| schedule_id | INT | FOREIGN KEY, NOT NULL | 班次ID |
| order_time | DATETIME | DEFAULT CURRENT_TIMESTAMP | 下单时间 |
| total_amount | DECIMAL(10,2) | NOT NULL | 订单总金额 |
| ticket_count | INT | NOT NULL | 票数 |
| order_type | ENUM('individual', 'group') | DEFAULT 'individual' | 订单类型 |
| status | ENUM('pending', 'confirmed', 'cancelled', 'refunded') | DEFAULT 'confirmed' | 订单状态 |

**索引**:
- PRIMARY KEY: order_id
- INDEX: user_id
- INDEX: schedule_id
- INDEX: order_time
- INDEX: status

**外键**:
- user_id REFERENCES User(user_id) ON DELETE CASCADE
- schedule_id REFERENCES Schedule(schedule_id)

---

#### Ticket (车票表)
每一张票都是独立记录

| 字段名 | 类型 | 约束 | 说明 |
|-------|------|------|------|
| ticket_id | INT | PRIMARY KEY, AUTO_INCREMENT | 车票ID |
| order_id | INT | FOREIGN KEY, NOT NULL | 订单ID |
| schedule_id | INT | FOREIGN KEY, NOT NULL | 班次ID |
| seat_id | INT | FOREIGN KEY, NOT NULL | 座位ID |
| passenger_name | VARCHAR(50) | NOT NULL | 乘客姓名 |
| card_id | VARCHAR(18) | NOT NULL | 身份证号 |
| price | DECIMAL(10,2) | NOT NULL | 票价 |
| status | ENUM('valid', 'refunded') | DEFAULT 'valid' | 车票状态 |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |

**索引**:
- PRIMARY KEY: ticket_id
- UNIQUE INDEX: (schedule_id, seat_id, status) -- 确保同一座位在同一班次不能被重复售出
- UNIQUE INDEX: (schedule_id, card_id, status) -- 确保同一身份证号在同一车次只能订一张票
- INDEX: order_id
- INDEX: schedule_id
- INDEX: seat_id
- INDEX: passenger_name
- INDEX: status
- INDEX: card_id

**外键**:
- order_id REFERENCES Order(order_id) ON DELETE CASCADE
- schedule_id REFERENCES Schedule(schedule_id)
- seat_id REFERENCES Seat(seat_id)

---

#### Refund (退票记录表)
记录退票信息

| 字段名 | 类型 | 约束 | 说明 |
|-------|------|------|------|
| refund_id | INT | PRIMARY KEY, AUTO_INCREMENT | 退票ID |
| ticket_id | INT | FOREIGN KEY, UNIQUE, NOT NULL | 车票ID |
| refund_time | DATETIME | DEFAULT CURRENT_TIMESTAMP | 退票时间 |
| refund_amount | DECIMAL(10,2) | NOT NULL | 退款金额 |
| refund_reason | TEXT | | 退票原因 |
| handled_by | INT | FOREIGN KEY | 处理人ID |

**索引**:
- PRIMARY KEY: refund_id
- UNIQUE INDEX: ticket_id
- INDEX: refund_time

**外键**:
- ticket_id REFERENCES Ticket(ticket_id)
- handled_by REFERENCES User(user_id)

---

## 三、数据库约束

### 3.1 完整性约束

1. **实体完整性**：所有表都有主键约束
2. **参照完整性**：外键约束确保引用的完整性
3. **用户定义完整性**：
   - 票价、金额必须 >= 0
   - 日期时间的合理性（到达时间 >= 发车时间）
   - 座位数量 > 0
   - 延误分钟数 >= 0

### 3.2 业务规则约束

1. 同一车辆在同一时间只能有一个班次
2. 同一座位在同一班次只能售出一次
3. 同一身份证号在同一车次只能订一张票（防止团报中重复订票）
4. 退票后座位应该释放，身份证号可重新购买该车次
5. 订单中的票数应等于实际车票数量

---

## 四、索引设计说明

### 4.1 主键索引
所有表都使用自增主键，自动创建聚集索引。

### 4.2 唯一索引
- 用户名、车辆编号等需要唯一性的字段
- 班次号+日期组合（防止重复）
- 线路+站点顺序组合（防止重复）

### 4.3 外键索引
所有外键字段都建立索引，加速关联查询。

### 4.4 查询优化索引
- 时间字段（departure_date, order_time等）：支持按日期查询
- 状态字段：支持按状态筛选
- 城市、车站名：支持模糊查询和精确查询
- 复合索引：(schedule_no, departure_date) 支持班次查询

---

## 五、并发控制设计

### 5.1 事务隔离级别
使用 READ COMMITTED 隔离级别，防止脏读。

### 5.2 锁机制

#### 订票事务
```sql
START TRANSACTION;

-- 1. 锁定座位行（悲观锁）
SELECT seat_id FROM Seat 
WHERE vehicle_id = ? AND seat_id NOT IN (
    SELECT seat_id FROM Ticket 
    WHERE schedule_id = ? AND status = 'valid'
)
LIMIT ? FOR UPDATE;

-- 2. 创建订单
INSERT INTO Order ...

-- 3. 创建车票
INSERT INTO Ticket ...

COMMIT;
```

#### 乐观锁方案（可选）
为Seat表增加version字段：
```sql
UPDATE Seat SET version = version + 1 
WHERE seat_id = ? AND version = ?
```

### 5.3 防止超卖和重复订票

使用数据库约束 + 应用层检查：

**防止座位超卖：**
1. 在Ticket表添加唯一约束：(schedule_id, seat_id, status)
2. 应用层在事务中先检查座位可用性
3. 使用FOR UPDATE锁定记录

**防止身份证号重复订票：**
1. 在Ticket表添加唯一约束：(schedule_id, card_id, status)
2. 应用层检查提交的乘客列表中是否有重复身份证号
3. 应用层检查数据库中该车次是否已有该身份证号的有效票
4. 约束包含status字段，退票后（status='refunded'）可以重新购买

---

## 六、数据字典

### 枚举类型说明

#### station_type (车站类型)
- `train`: 火车站
- `bus`: 汽车站
- `both`: 火车站+汽车站

#### route_type (线路类型)
- `train`: 火车线路
- `bus`: 汽车线路

#### seat_type (座位类型)
- `hard_seat`: 硬座
- `soft_seat`: 软座
- `hard_sleeper`: 硬卧
- `soft_sleeper`: 软卧
- `business`: 商务座
- `first_class`: 一等座
- `second_class`: 二等座

#### status (状态)
**Schedule.status (班次状态)**
- `normal`: 正常
- `delayed`: 延误
- `cancelled`: 取消

**Order.status (订单状态)**
- `pending`: 待确认
- `confirmed`: 已确认
- `cancelled`: 已取消
- `refunded`: 已退款

**Ticket.status (车票状态)**
- `valid`: 有效
- `refunded`: 已退票

#### order_type (订单类型)
- `individual`: 个人订单
- `group`: 团体订单

---

## 七、性能优化建议

### 7.1 分区表
对于大数据量的表，可以按时间分区：
- Order表按order_time月度分区
- Ticket表按created_at月度分区
- Admin_Log表按operation_time月度分区

### 7.2 查询优化
1. 使用覆盖索引减少回表
2. 合理使用EXPLAIN分析查询计划
3. 避免SELECT *，只查询需要的字段
4. 使用JOIN代替子查询（在合适的场景）

### 7.3 缓存策略
1. 车站信息、线路信息等静态数据可缓存
2. 热门班次信息可缓存
3. 使用Redis缓存用户会话

### 7.4 读写分离
在高并发场景下，可以配置MySQL主从复制：
- 主库：处理写操作（订票、退票）
- 从库：处理读操作（查询）

---

## 八、数据安全

### 8.1 敏感信息加密
- 用户密码使用bcrypt加密
- 身份证号可考虑加密存储
- 会话token使用随机安全字符串

### 8.2 SQL注入防护
- 使用参数化查询
- 对用户输入进行验证和过滤

### 8.3 备份策略
- 每日全量备份
- 每小时增量备份
- 保留最近30天的备份

---

## 附录：表关系总结

```
核心业务流程：
User → Order → Ticket → Refund
         ↓       ↓
      Schedule  Seat
         ↓
      Route → Route_Station → Station
         ↓
      Vehicle

辅助功能：
User → Session (会话管理)
User → Admin_Log (操作审计)
```

